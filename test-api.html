<!DOCTYPE html>
<html>
<head>
    <title>Together AI API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        #results {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Together AI API Test</h1>
    <p>This page tests the connection to the Together AI API to help diagnose issues with the Mochi extension.</p>
    
    <button id="runTest">Run API Test</button>
    
    <div id="results">Results will appear here...</div>
    
    <script>
        // Configuration (same as in config.js)
        const config = {
            togetherAI: {
                apiEndpoint: "https://api.together.xyz/v1/chat/completions",
                model: "meta-llama/Llama-4-Scout-17B-16E-Instruct",
                defaultApiKey: "f2082dc55d67c63c00e0ecc647e3e5337887254acfa8d4f9a162cbbfb201779f"
            }
        };

        // Function to log to the results div
        function log(message, isError = false) {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            
            if (typeof message === 'object') {
                message = JSON.stringify(message, null, 2);
            }
            
            const formattedMessage = `[${timestamp}] ${message}`;
            
            if (isError) {
                resultsDiv.innerHTML += `<div style="color: red;">${formattedMessage}</div>`;
            } else {
                resultsDiv.innerHTML += `<div>${formattedMessage}</div>`;
            }
            
            // Auto-scroll to bottom
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Test function to make a direct API call
        async function testAPI() {
            log('Starting API test...');
            
            const apiKey = config.togetherAI.defaultApiKey;
            const endpoint = config.togetherAI.apiEndpoint;
            const model = config.togetherAI.model;
            
            log(`API Key: ${apiKey.substring(0, 5)}...${apiKey.substring(apiKey.length - 5)}`);
            log(`Endpoint: ${endpoint}`);
            log(`Model: ${model}`);
            
            const requestBody = {
                model: model,
                messages: [
                    {
                        role: "system",
                        content: "You are a helpful assistant that simplifies text."
                    },
                    {
                        role: "user",
                        content: "Please simplify this text: The quantum mechanical model is a model that explains the movement of electrons in atoms and molecules. It is based on quantum mechanics, which is a branch of physics that deals with the behavior of matter and light on the atomic and subatomic scale."
                    }
                ],
                temperature: 0.3,
                max_tokens: 1000,
                stream: false
            };
            
            try {
                log('Sending request...');
                log('Request body:', requestBody);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log('Response status: ' + response.status);
                
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                log('Response headers:', headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('Error response: ' + errorText, true);
                    try {
                        const errorData = JSON.parse(errorText);
                        log('Parsed error:', errorData, true);
                    } catch (e) {
                        log('Could not parse error response as JSON', true);
                    }
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                log('API response:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    log('Simplified text: ' + data.choices[0].message.content);
                    log('Test completed successfully!');
                } else {
                    log('Invalid response format:', data, true);
                }
            } catch (error) {
                log('Test failed: ' + error.message, true);
            }
        }

        // Add event listener to the button
        document.getElementById('runTest').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            // Run the test
            testAPI();
        });
    </script>
</body>
</html>
